# a-tree-ffi

C/C++ Foreign Function Interface (FFI) bindings for the [a-tree](https://crates.io/crates/a-tree) library.

## Overview

This crate provides a simple, stable C API for using the A-Tree data structure from C and C++ applications. The A-Tree efficiently indexes and evaluates large numbers of arbitrary boolean expressions.

## Features

- **Clean C API**: Simple, well-documented C functions
- **Type-safe**: Uses C enums and structs for safety
- **RAII C++ wrapper**: Optional modern C++ wrapper (see examples)
- **Zero dependencies**: Only depends on the core `a-tree` crate
- **Static and dynamic linking**: Builds both `.a` and `.so`/`.dylib` libraries

## Building

### Build the FFI library

```bash
cd a-tree-ffi
cargo build --release
```

This generates:
- `target/release/liba_tree_ffi.so` (or `.dylib` on macOS, `.dll` on Windows)
- `target/release/liba_tree_ffi.a`
- `atree.h` - C header file (auto-generated by cbindgen)

### Build the C example

```bash
cd a-tree-ffi

# Compile
gcc examples/example.c \
    -I. \
    -L target/release \
    -la_tree_ffi \
    -lpthread -ldl -lm \
    -Wl,-rpath,$(pwd)/target/release \
    -o example_c

# Run
./example_c
```

### Build the C++ example

```bash
cd a-tree-ffi

# Compile
g++ -std=c++17 examples/example.cpp \
    -I. \
    -L target/release \
    -la_tree_ffi \
    -lpthread -ldl -lm \
    -Wl,-rpath,$(pwd)/target/release \
    -o example_cpp

# Run
./example_cpp
```

## Quick Start (C)

```c
#include "atree.h"
#include <stdio.h>

int main(void) {
    // Define attributes
    AtreeAttributeDef defs[] = {
        { .name = "exchange_id", .attr_type = Integer },
        { .name = "private", .attr_type = Boolean }
    };

    // Create A-Tree
    ATreeHandle *tree = atree_new(defs, 2);

    // Insert expression
    atree_insert(tree, 1, "exchange_id = 1 and private");

    // Build event
    EventBuilder *builder = atree_event_builder_new(tree);
    atree_event_builder_with_integer(builder, "exchange_id", 1);
    atree_event_builder_with_boolean(builder, "private", true);

    // Search
    AtreeSearchResult result = atree_search(tree, builder);
    printf("Found %zu matches\n", result.count);

    // Cleanup
    atree_search_result_free(result);
    atree_free(tree);

    return 0;
}
```

## Quick Start (C++)

```cpp
#include "atree.h"
#include <iostream>

// Use the RAII wrappers from examples/example.cpp

int main() {
    // Create A-Tree
    ATreeWrapper tree({
        {"exchange_id", Integer},
        {"private", Boolean}
    });

    // Insert expression
    tree.insert(1, "exchange_id = 1 and private");

    // Build and search
    EventBuilderWrapper builder(tree.create_event_builder());
    auto matches = tree.search(
        builder.with_integer("exchange_id", 1)
               .with_boolean("private", true)
               .release()
    );

    std::cout << "Found " << matches.size() << " matches\n";
    return 0;
}
```

## API Reference

### Types

- `ATreeHandle` - Opaque handle to an A-Tree instance
- `EventBuilder` - Opaque handle to an event builder
- `AtreeAttributeType` - Enum for attribute types (Boolean, Integer, Float, String, StringList, IntegerList)
- `AtreeAttributeDef` - Struct defining an attribute (name + type)
- `AtreeResult` - Result type for operations (success flag + optional error message)
- `AtreeSearchResult` - Search results (array of IDs + count)

### Functions

#### Tree Management
- `atree_new(defs, count)` - Create a new A-Tree
- `atree_free(handle)` - Free an A-Tree

#### Expression Management
- `atree_insert(handle, id, expression)` - Insert a boolean expression

#### Event Building
- `atree_event_builder_new(handle)` - Create an event builder
- `atree_event_builder_with_boolean(builder, name, value)` - Add boolean attribute
- `atree_event_builder_with_integer(builder, name, value)` - Add integer attribute
- `atree_event_builder_with_string(builder, name, value)` - Add string attribute
- `atree_event_builder_free(builder)` - Free unused builder

#### Searching
- `atree_search(handle, builder)` - Search for matching expressions (consumes builder)
- `atree_search_result_free(result)` - Free search results

#### Error Handling
- `atree_free_error(error)` - Free error message string

## Memory Management

**Important**:
- All `_new()` functions return pointers that must be freed with corresponding `_free()` functions
- `atree_search()` consumes the EventBuilder - don't use it after calling search
- Error messages in `AtreeResult` must be freed with `atree_free_error()` when `success == false`

## Thread Safety

The A-Tree itself is **not** thread-safe. If you need concurrent access:
- Protect the tree with a mutex/lock
- Use multiple trees (one per thread)

## Integration with CMake

```cmake
cmake_minimum_required(VERSION 3.15)
project(my_project)

# Find the FFI library
find_library(ATREE_FFI_LIB a_tree_ffi HINTS path/to/a-tree-ffi/target/release)

add_executable(my_app main.c)
target_include_directories(my_app PRIVATE path/to/a-tree-ffi)
target_link_libraries(my_app PRIVATE ${ATREE_FFI_LIB} pthread dl m)
```

## License

This project is licensed under the same terms as a-tree: [Apache 2.0](../LICENSE-APACHE) or [MIT License](../LICENSE-MIT).
